<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>Index</title>
    <link rel="stylesheet" type="text/css" href="./css/style.css">
  </head>
  <body>
     <div class="cover"></div>
     <div class="musicbox">
       <div class="music-panel">
         <div class="music">
           <div class="info">
             <div class="title">My song example</div>
             <div class="auther">auther</div>
           </div>
           <div class="musicImgContent">
             <div>
              <img src="" class="musicImg" id="musicImg">
             </div>
           </div>
           <div class="control">
             <span class="play-button">
               <i class="iconfont icon-xunhuanbofang"></i>
             </span>
             <span class="play-button" id="previous">
               <i class="iconfont icon-PrevioustrackFill"></i>
             </span>
             <span class="play-button" id="play">
               <i class="iconfont icon-PlayFilled"></i>
             </span>
             <span class="play-button" id="next">
               <i class="iconfont icon-NexttrackFilled"></i>
             </span>
           </div>

         <div class="progress">
           <div class="bar">
             <div class="progress-total"></div>
             <div class="progress-now"></div>
           </div>
         </div>
         <div class="time">0:00</div>
         </div>
       </div>
       <ul class="list">
         
       </ul>
     </div>
  </body>
</html>
<script>
  let currentIndex = 0;
  const clock = null;
  const audio = new Audio();
  let musicList = [];
  audio.autoplay = false;
  let playButton = document.getElementById('play');
  let nextButton = document.getElementById('next');
  let previousButton = document.getElementById('previous');
  let musicImg = document.getElementById('musicImg');

  const playClassList = playButton.children[0].classList;
  const nextClassList = nextButton.children[0].classList;

  $('.musicbox .musicImgContent').style.animationPlayState = "paused";
  $('.musicbox .musicImg').style.animationPlayState = "paused";

  getMusicList(function(list) {
    musicList = list;
    loadMusic(list[currentIndex]);
  })

  playButton.onclick = function(){ 
    if(playClassList.contains('icon-PlayFilled')){  
       audio.play();
    } else {
       audio.pause();
    }
  }

  nextButton.onclick = function(){
    if(musicList.length !== 0){
      currentIndex = (++currentIndex)%musicList.length;
      loadMusic(musicList[currentIndex]);
    }
  }

  previousButton.onclick = function(){
    if(musicList.length !== 0){
      currentIndex = (musicList.length + (--currentIndex))%musicList.length;
      loadMusic(musicList[currentIndex]);
    }
  }


  audio.ontimeupdate = function(){
    $('.musicbox .progress-now').style.width = (this.currentTime/this.duration)*100 + '%';
    let min = Math.floor(this.currentTime / 60);
    let sec = Math.floor(this.currentTime) % 60 + '';
    sec = sec.length === 2? sec : '0' + sec;
    $('.musicbox .time').innerText = min + ':' + sec;
  }

  audio.addEventListener('playing',function(){ 
    playClassList.remove('icon-PlayFilled');
    playClassList.add('icon-PauseFilled');
    $('.musicbox .musicImgContent').style.animationPlayState = "running";
    $('.musicbox .musicImg').style.animationPlayState = "running";
  });

   audio.addEventListener('pause',function(){
    playClassList.remove('icon-PauseFilled');
    playClassList.add('icon-PlayFilled');
    $('.musicbox .musicImgContent').style.animationPlayState = "paused";
    $('.musicbox .musicImg').style.animationPlayState = "paused";
  })

  audio.onplay = function() {
    clock = setInterval(function(){
      let min = Math.floor(audio.currentTime/60);
      let sec = Math.floor(audio.currentTime)%60 + '';
      sec = sec.length ===2? sec : '0' + sec;
      $('.musicbox .time').innerText = min + ':' + sec;
    },1000)
  }

  audio.onpause = function(){
    clearInterval(clock);
  }

  function $(selector){
    return document.querySelector(selector);
  }

  function loadMusic(musicObj){
    
    $('.musicbox .title').innerText = musicObj.title;
    $('.musicbox .auther').innerText = musicObj.auther;
    
    musicImg.src = musicObj.img;

    audio.src = musicObj.url;
    audio.play();
  }

  function getMusicList(callback){
    const xhr = new XMLHttpRequest();
    xhr.open('GET','/getMusicList',true);
    xhr.onload = function(){
      if((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304){
        callback(JSON.parse(this.responseText));
      }else{
        console.log('获取数据失败');
      }
    }
    xhr.onerror = function(){
      console.log('网络异常');
    }
    xhr.send();
  }
</script>